<!-- 2025-12-19 17:33 iPhone 14 相容 + 大卡片版 UI -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>圖片上傳測試（防跳轉版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }
    .file-input-overlay {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-md rounded-3xl shadow-xl px-6 py-8">
    <h1 class="text-xl font-semibold text-center text-gray-800 mb-6">
      圖片上傳測試（防跳轉版）
    </h1>
    <!-- 預覽區 -->
    <div class="border-2 border-dashed border-gray-300 rounded-2xl bg-gray-50 flex items-center justify-center h-64 mb-6 overflow-hidden">
      <span id="placeholderText" class="text-gray-400 text-base">
        尚未選擇圖片
      </span>
      <img id="previewImage" alt="預覽圖片" class="hidden w-full h-full object-contain">
    </div>
    <!-- 操作按鈕 -->
    <div class="space-y-3">
      <button
        id="uploadBtn"
        class="relative w-full flex items-center justify-center gap-2 bg-blue-600 active:bg-blue-700 text-white text-base font-medium py-3 rounded-2xl shadow-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
        </svg>
        選擇照片
        <!-- 透明覆蓋的 input -->
        <input type="file" id="fileInput" accept="image/*" class="file-input-overlay">
      </button>
      <button
        id="downloadBtn"
        disabled
        class="w-full flex items-center justify-center gap-2 bg-gray-300 text-gray-500 text-base font-medium py-3 rounded-2xl">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        下載 / 開啟照片
      </button>
    </div>
    <!-- 狀態列 -->
    <div id="statusMsg" class="mt-4 text-sm text-gray-600 h-5 text-center"></div>
  </div>
  <script>
    const fileInput = document.getElementById('fileInput');
    const previewImage = document.getElementById('previewImage');
    const placeholderText = document.getElementById('placeholderText');
    const statusMsg = document.getElementById('statusMsg');
    const downloadBtn = document.getElementById('downloadBtn');
    let currentFileUrl = null;
    let originalFileName = 'image.png';
    const isIOS = /iP(hone|od|ad)/.test(navigator.platform) ||
                  (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    // 檔案選擇後處理
    fileInput.addEventListener('change', function (e) {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        statusMsg.textContent = '尚未選擇檔案';
        return;
      }
      originalFileName = file.name;
      statusMsg.textContent = '讀取中…';
      // 清掉舊的 URL
      if (currentFileUrl) {
        URL.revokeObjectURL(currentFileUrl);
        currentFileUrl = null;
      }
      if (isIOS) {
        // iPhone / iPad：用 FileReader + DataURL
        const reader = new FileReader();
        reader.onload = function (evt) {
          const dataUrl = evt.target.result;
          if (!dataUrl) {
            statusMsg.textContent = '錯誤：無法讀取圖片';
            return;
          }
          previewImage.src = dataUrl;
          previewImage.classList.remove('hidden');
          placeholderText.classList.add('hidden');
          downloadBtn.disabled = true; // iOS 不處理下載，只做預覽
          statusMsg.textContent =
            '已載入（iOS）: ' + file.name + '（' + Math.round(file.size / 1024) + ' KB）';
        };
        reader.onerror = function () {
          statusMsg.textContent = '錯誤：讀取失敗';
        };
        reader.readAsDataURL(file);
      } else {
        // 其它瀏覽器：Blob URL + 下載
        currentFileUrl = URL.createObjectURL(file);
        previewImage.src = currentFileUrl;
        previewImage.classList.remove('hidden');
        placeholderText.classList.add('hidden');
        downloadBtn.disabled = false;
        statusMsg.textContent =
          '已載入: ' + file.name + '（' + Math.round(file.size / 1024) + ' KB）';
      }
    });
    // 下載：僅非 iOS 啟用
    downloadBtn.addEventListener('click', function () {
      if (!currentFileUrl) return;
      if (isIOS) {
        statusMsg.textContent = 'iOS Safari 僅支援預覽，下載請改用電腦瀏覽器。';
        return;
      }
      try {
        const a = document.createElement('a');
        a.href = currentFileUrl;
        a.download = 'copy_' + originalFileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        statusMsg.textContent = '下載已觸發';
      } catch (err) {
        statusMsg.textContent = '下載失敗：' + err.message;
      }
    });
  </script>
</body>
</html>
